version: 1
metadata:
  name: __DOMAIN__ Stalwart Mail Integration
  labels:
    type: custom
entries:
  # 1. OAuth2 Provider
  - model: authentik_providers_oauth2.oauth2provider
    id: stalwart-provider
    identifiers:
      name: Stalwart Mail Provider
    attrs:
      client_id: __CLIENT_ID__
      client_secret: __CLIENT_SECRET__
      # Stalwart expects the callback at /auth/oidc
      redirect_uris:
        - matching_mode: strict
          url: https://mail.test.local/auth/oidc
      token_validity: hours=1
      
      # Required Flows
      authorization_flow: !Find [authentik_flows.flow, [slug, "default-provider-authorization-implicit-consent"]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, "default-provider-invalidation-flow"]]

      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "email"]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "profile"]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "openid"]]
    state: present

  # 2. Application
  - model: authentik_core.application
    id: stalwart-app
    identifiers:
      slug: stalwart-mail
    attrs:
      name: Stalwart Mail
      slug: stalwart-mail
      icon: https://goauthentik.io/img/icon.png      
      provider: !KeyOf stalwart-provider
      policy_engine_mode: any
    state: present