version: 1
metadata:
  name: __DOMAIN__ Stalwart Mail Integration
  labels:
    type: custom
entries:
  # 1. LDAP Provider
  - model: authentik_providers_ldap.ldapprovider
    id: stalwart-ldap-provider
    identifiers:
      name: Stalwart LDAP
    attrs:
      base_dn: "__LDAP_BASE_DN__"
      search_mode: cached
      bind_mode: cached
      authorization_flow: !Find [authentik_flows.flow, [slug, "default-authentication-flow"]]
      search_group: !Find [authentik_core.group, [name, "authentik Admins"]]
    state: present

  # 2. Application
  - model: authentik_core.application
    id: stalwart-app
    identifiers:
      slug: stalwart-mail
    attrs:
      name: Stalwart Mail
      slug: stalwart-mail
      icon: https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/png/stalwart.png
      provider: !KeyOf stalwart-ldap-provider
      policy_engine_mode: any
    state: present

  # 3. API token for the LDAP outpost container
  - model: authentik_core.token
    identifiers:
      identifier: stalwart-ldap-outpost-token
    attrs:
      user: !Find [authentik_core.user, [username, "akadmin"]]
      key: "__LDAP_OUTPOST_TOKEN__"
      intent: api
      expiring: false
    state: present

  # 4. LDAP Outpost
  - model: authentik_outposts.outpost
    id: stalwart-ldap-outpost
    identifiers:
      name: "Stalwart LDAP Outpost"
    attrs:
      type: ldap
      token_identifier: stalwart-ldap-outpost-token
      providers:
        - !KeyOf stalwart-ldap-provider
    state: present
