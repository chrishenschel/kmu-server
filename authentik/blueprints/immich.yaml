version: 1
metadata:
  name: __DOMAIN__ Immich Integration
  labels:
    type: custom
entries:
  # OAuth2/OIDC Provider for Immich (web + mobile redirect URIs)
  - model: authentik_providers_oauth2.oauth2provider
    id: immich-provider
    identifiers:
      name: Immich Provider
    attrs:
      client_id: __IMMICH_CLIENT_ID__
      client_secret: __IMMICH_CLIENT_SECRET__
      redirect_uris:
        - matching_mode: strict
          url: app.immich:///oauth-callback
        - matching_mode: strict
          url: https://immich.__DOMAIN__/auth/login
        - matching_mode: strict
          url: https://immich.__DOMAIN__/user-settings
      token_validity: hours=1
      sub_mode: user_uuid
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
      authorization_flow: !Find [authentik_flows.flow, [slug, "default-provider-authorization-implicit-consent"]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, "default-provider-invalidation-flow"]]
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "openid"]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "email"]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "profile"]]
    state: present

  # Application (optional Launch URL for auto-login from Authentik dashboard)
  - model: authentik_core.application
    id: immich-app
    identifiers:
      slug: immich
    attrs:
      name: Immich
      slug: immich
      icon: https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/png/immich.png
      provider: !KeyOf immich-provider
      policy_engine_mode: any
      launch_url: https://immich.__DOMAIN__/auth/login?autoLaunch=1
    state: present
