version: 1
metadata:
  name: __DOMAIN__ Nextcloud Integration
  labels:
    type: custom
entries:
  # 1. Custom Scope Mapping (provides groups, quota, and user_id to Nextcloud)
  - model: authentik_providers_oauth2.scopemapping
    id: nextcloud-scope
    identifiers:
      name: "Nextcloud Profile"
    attrs:
      scope_name: nextcloud
      expression: |
        groups = [group.name for group in user.groups.all()]
        if user.is_superuser and "admin" not in groups:
            groups.append("admin")
        return {
            "name": request.user.name,
            "groups": groups,
            "quota": user.group_attributes().get("nextcloud_quota", None),
            "user_id": user.attributes.get("nextcloud_user_id", str(user.uuid)),
        }
    state: present

  # 2. OAuth2/OIDC Provider
  - model: authentik_providers_oauth2.oauth2provider
    id: nextcloud-provider
    identifiers:
      name: Nextcloud Provider
    attrs:
      client_id: __NC_CLIENT_ID__
      client_secret: __NC_CLIENT_SECRET__
      redirect_uris:
        - matching_mode: strict
          url: https://cloud.__DOMAIN__/apps/user_oidc/code
      token_validity: hours=1
      sub_mode: user_uuid
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
      authorization_flow: !Find [authentik_flows.flow, [slug, "default-provider-authorization-implicit-consent"]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, "default-provider-invalidation-flow"]]
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "email"]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "profile"]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "openid"]]
        - !KeyOf nextcloud-scope
    state: present

  # 3. Application
  - model: authentik_core.application
    id: nextcloud-app
    identifiers:
      slug: nextcloud
    attrs:
      name: Nextcloud
      slug: nextcloud
      icon: https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/png/nextcloud.png
      provider: !KeyOf nextcloud-provider
      policy_engine_mode: any
    state: present
