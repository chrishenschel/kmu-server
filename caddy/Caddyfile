{
    acme_ca https://acme-v02.api.letsencrypt.org/directory
    email   hostmaster@__DOMAIN__
}

www.__DOMAIN__ __DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    handle /.well-known/matrix/client {
        header Content-Type application/json
        header Access-Control-Allow-Origin *
        respond `{"m.homeserver":{"base_url":"https://matrix.__DOMAIN__"}}`
    }

    handle /.well-known/matrix/server {
        header Content-Type application/json
        respond `{"m.server":"matrix.__DOMAIN__:443"}`
    }

    handle /_matrix/* {
        reverse_proxy synapse:8008
    }

    handle /_synapse/* {
        reverse_proxy synapse:8008
    }

    handle {
        reverse_proxy homepage:80
    }
}

auth.__DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    reverse_proxy authentik-server:9000
}

mail.__DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    reverse_proxy stalwart-mail:8080
}

matrix.__DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    reverse_proxy synapse:8008
}

element.__DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    # Outpost path (callback, etc.) must be proxied to Authentik so login redirect works
    handle /outpost.goauthentik.io/* {
        reverse_proxy authentik-server:9000
    }
    handle {
        forward_auth authentik-server:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks X-Authentik-Meta-Outpost X-Authentik-Meta-Provider X-Authentik-Meta-App X-Authentik-Meta-Version
        }
        reverse_proxy element:80
    }
}

cloud.__DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    redir /.well-known/carddav /remote.php/dav 301
    redir /.well-known/caldav /remote.php/dav 301
    redir /.well-known/webfinger /index.php/.well-known/webfinger 301
    redir /.well-known/nodeinfo /index.php/.well-known/nodeinfo 301

    reverse_proxy nextcloud:80
}

logs.__DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    # Outpost path (callback, etc.) must be proxied to Authentik so login redirect works
    handle /outpost.goauthentik.io/* {
        reverse_proxy authentik-server:9000
    }
    handle {
        # 1. FORWARD AUTH: Ask Authentik for permission
        forward_auth authentik-server:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks X-Authentik-Meta-Outpost X-Authentik-Meta-Provider X-Authentik-Meta-App X-Authentik-Meta-Version
        }
        # 2. If allowed, show the logs
        reverse_proxy dozzle:8080
    }
}

meet.__DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    # Authentik outpost callback path
    handle /outpost.goauthentik.io/* {
        reverse_proxy authentik-server:9000
    }
    # Already have JWT (e.g. after meet-sso redirect): serve Jitsi directly to avoid redirect loop
    @with_jwt {
        query jwt=*
    }
    handle @with_jwt {
        reverse_proxy jitsi-web:80
    }
    # Main page (/) — authenticated users only; meet-sso issues JWT and redirects to /?jwt=
    handle / {
        forward_auth authentik-server:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks X-Authentik-Meta-Outpost X-Authentik-Meta-Provider X-Authentik-Meta-App X-Authentik-Meta-Version
        }
        reverse_proxy meet-sso:8000
    }
    # Login path: get JWT and redirect to room as moderator
    handle_path /login* {
        forward_auth authentik-server:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks X-Authentik-Meta-Outpost X-Authentik-Meta-Provider X-Authentik-Meta-App X-Authentik-Meta-Version
        }
        reverse_proxy meet-sso:8000
    }
    # Direct room URLs (e.g. /myroom) — no auth, guests join via link
    handle {
        reverse_proxy jitsi-web:80
    }
}

start.__DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    handle /outpost.goauthentik.io/* {
        reverse_proxy authentik-server:9000
    }
    # Endpoint for the start page to check if user is in admin group (for Start/Admin view toggle)
    handle_path /auth-check {
        forward_auth authentik-server:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks X-Authentik-Meta-Outpost X-Authentik-Meta-Provider X-Authentik-Meta-App X-Authentik-Meta-Version
        }
        header X-Authentik-Groups "{http.request.header.X-Authentik-Groups}"
        header Access-Control-Expose-Headers "X-Authentik-Groups"
        respond 204
    }
    handle {
        forward_auth authentik-server:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks X-Authentik-Meta-Outpost X-Authentik-Meta-Provider X-Authentik-Meta-App X-Authentik-Meta-Version
        }
        reverse_proxy startpage:80
    }
}

admin.__DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    handle /outpost.goauthentik.io/* {
        reverse_proxy authentik-server:9000
    }
    handle {
        forward_auth authentik-server:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks X-Authentik-Meta-Outpost X-Authentik-Meta-Provider X-Authentik-Meta-App X-Authentik-Meta-Version
        }
        reverse_proxy admin-panel:8000
    }
}

vaultwarden.__DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    # No forward_auth: Vaultwarden login page offers SSO; OIDC callback is /identity/connect/oidc-signin
    reverse_proxy vaultwarden:80
}

immich.__DOMAIN__ {
    log {
        output file /var/log/caddy/access.log
    }
    # No forward_auth: Immich handles OAuth login at /auth/login and /user-settings
    reverse_proxy immich-server:2283
}