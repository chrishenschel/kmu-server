services:
  caddy:
    image: caddy
    container_name: caddy-proxy
    restart: unless-stopped
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./caddy/data:/data
      - ./caddy/config:/config
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
    networks:
      - caddy-proxy
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:2019/config/ || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  postgres:
    env_file:
      - .env
    # image: postgres:alpine
    build:
      context: ./postgres
      dockerfile: Dockerfile
    container_name: postgres
    restart: unless-stopped
    # ports:
    #   - 5432:5432
    environment:
      POSTGRES_PASSWORD: "${PG_PASS}"
      POSTGRES_USER: postgres
      POSTGRES_MULTIPLE_DATABASES: authentik,matrix,stalwart,nextcloud
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - database:/var/lib/postgresql/data
      - ./postgres/init-multiple-databases.sh:/docker-entrypoint-initdb.d/init-multiple-databases.s
    networks:
      - database
  postgres-backup:
    image: prodrigestivill/postgres-backup-local
    container_name: postgres-backup
    restart: always
    volumes:
      - ./backups/postgres:/backups
    depends_on:
      - postgres
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD="${PG_PASS}"
      - SCHEDULE=@daily
      - BACKUP_KEEP_DAYS=7
      - BACKUP_KEEP_WEEKS=4
      - BACKUP_KEEP_MONTHS=6
  dozzle:
    container_name: dozzle
    image: amir20/dozzle:latest
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - caddy-proxy
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:8080/ || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  authentikserver:
    image: ghcr.io/goauthentik/server:2025.12.4
    command: server
    container_name: authentik-server
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env
    environment:
      AUTHENTIK_POSTGRESQL__HOST: postgres
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_POSTGRESQL__PASSWORD: "${PG_PASS}"
      AUTHENTIK_POSTGRESQL__USER: postgres
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?secret key required}
      AUTHENTIK_WEB__EXTERNAL_HOST: "https://auth.${DOMAIN}"
      # Required to skip the setup wizard
      AUTHENTIK_BOOTSTRAP_PASSWORD: ${AUTHENTIK_BOOTSTRAP_PASSWORD:?password required}
      AUTHENTIK_BOOTSTRAP_TOKEN: ${AUTHENTIK_BOOTSTRAP_TOKEN:?token required}
      AUTHENTIK_BOOTSTRAP_EMAIL: ${AUTHENTIK_BOOTSTRAP_EMAIL:?email required}
    # ports:
    #   - ${COMPOSE_PORT_HTTP:-9000}:9000
    #   - ${COMPOSE_PORT_HTTPS:-9443}:9443
    restart: unless-stopped
    volumes:
      - ./authentik/data:/data
      - ./authentik/custom-templates:/templates
      - ./authentik/blueprints:/blueprints/custom
    networks:
      - caddy-proxy
      - database
  worker:
    image: ghcr.io/goauthentik/server:2025.12.4
    container_name: authentik-worker
    command: worker
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env
    environment:
      AUTHENTIK_POSTGRESQL__HOST: postgres
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_POSTGRESQL__PASSWORD: "${PG_PASS}"
      AUTHENTIK_POSTGRESQL__USER: postgres
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?secret key required}
      AUTHENTIK_HOST: "https://auth.${DOMAIN}"
      AUTHENTIK_EXTERNAL_HOST: "https://auth.${DOMAIN}"
      AUTHENTIK_WEB__EXTERNAL_HOST: "https://auth.${DOMAIN}"
      # Required to skip the setup wizard
      AUTHENTIK_BOOTSTRAP_PASSWORD: ${AUTHENTIK_BOOTSTRAP_PASSWORD:?password required}
      AUTHENTIK_BOOTSTRAP_TOKEN: ${AUTHENTIK_BOOTSTRAP_TOKEN:?token required}
      AUTHENTIK_BOOTSTRAP_EMAIL: ${AUTHENTIK_BOOTSTRAP_EMAIL:?email required}
    restart: unless-stopped
    user: root
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./authentik/data:/data
      - ./authentik/certs:/certs
      - ./authentik/custom-templates:/templates
      - ./authentik/blueprints:/blueprints/custom
    networks:
      - database

  ## Synapse / Element / MATRIX
  synapse:
    image: ghcr.io/element-hq/synapse:latest
    container_name: synapse
    env_file:
      - .env
    volumes:
      - ./synapse/data:/data
    environment:
      SYNAPSE_CONFIG_DIR: /data
      SYNAPSE_CONFIG_PATH: /data/homeserver.yaml
      TZ: "Europe/Berlin"
    depends_on:
      postgres:
        condition: service_healthy
      #ports:
      # Client-Server API
      #- "8008:8008"
      # Federation API
      #- "8448:8448"
    networks:
      - caddy-proxy
      - database
    restart: unless-stopped

  element:
    container_name: element
    image: vectorim/element-web:latest
    restart: unless-stopped
    volumes:
      - ./element/config.json:/app/config.json
    networks:
      - caddy-proxy

  ## Authentik LDAP Outpost (for Stalwart user authentication)
  authentik-ldap:
    image: ghcr.io/goauthentik/ldap:2025.12.4
    container_name: authentik-ldap
    restart: unless-stopped
    environment:
      AUTHENTIK_HOST: http://authentik-server:9000
      AUTHENTIK_INSECURE: "true"
      AUTHENTIK_TOKEN: "${LDAP_OUTPOST_TOKEN}"
    depends_on:
      - authentikserver
    networks:
      - caddy-proxy

  ## Mailserver
  stalwart:
    image: stalwartlabs/stalwart:latest
    container_name: stalwart-mail
    restart: unless-stopped
    volumes:
      - ./stalwart/data:/opt/stalwart
      - ./caddy/data:/opt/stalwart/caddy-data:ro
    ports:
      - "25:25" # SMTP
      - "465:465" # SMTPS
      - "993:993" # IMAPS
    depends_on:
      postgres:
        condition: service_healthy
      authentik-ldap:
        condition: service_started
    networks:
      - caddy-proxy
      - database
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:8080/login || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s

  ## Nextcloud
  nextcloud:
    image: nextcloud:latest
    container_name: nextcloud
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./nextcloud/apps:/var/www/html/custom_apps
      - ./nextcloud/config:/var/www/html/config
      - ./nextcloud/data:/var/www/html/data
      - ./nextcloud/theme:/var/www/html/themes/nextcloud-theme
      - ./admin/nextcloud-scripts:/usr/local/nextcloud-scripts:ro
    environment:
      - NEXTCLOUD_ADMIN_USER=${USERNAME}
      - NEXTCLOUD_ADMIN_PASSWORD=${PASSWORD}
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${PG_PASS}
      - POSTGRES_HOST=postgres
      - NEXTCLOUD_TRUSTED_DOMAINS=cloud.${DOMAIN}
      - OVERWRITEPROTOCOL=https
      - OVERWRITECLIURL=https://cloud.${DOMAIN}
      - FC_NO_CACHE=1
    networks:
      - caddy-proxy
      - database
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://localhost/status.php || exit 1" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 40s

  ## User sync (Authentik -> Stalwart)
  user-sync:
    image: python:3-alpine
    container_name: user-sync
    restart: unless-stopped
    command: python3 /app/user-sync.py
    volumes:
      - ./scripts/user-sync.py:/app/user-sync.py:ro
    environment:
      DOMAIN: "${DOMAIN}"
      STALWART_URL: "http://stalwart-mail:8080"
      STALWART_ADMIN_USER: "admin"
      STALWART_ADMIN_PASS: "${PASSWORD}"
      AUTHENTIK_URL: "http://authentik-server:9000"
      AUTHENTIK_TOKEN: "${AUTHENTIK_BOOTSTRAP_TOKEN}"
      SYNC_INTERVAL: "300"
    depends_on:
      - authentikserver
      - stalwart
    networks:
      - caddy-proxy
    healthcheck:
      test:
        - CMD-SHELL
        - >
          python - << 'PY'
          import sys, urllib.request
          try:
              urllib.request.urlopen("http://authentik-server:9000/-/health/live/", timeout=5)
              sys.exit(0)
          except Exception:
              sys.exit(1)
          PY
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  ## Admin panel (user management; protected by Authentik)
  admin-panel:
    image: python:3.12-slim
    container_name: admin-panel
    restart: unless-stopped
    working_dir: /app
    command: sh -c "pip install -q --no-cache-dir -r /app/requirements.txt && exec uvicorn app.main:app --host 0.0.0.0 --port 8000"
    environment:
      AUTHENTIK_URL: "http://authentik-server:9000"
      AUTHENTIK_TOKEN: "${AUTHENTIK_BOOTSTRAP_TOKEN}"
      STALWART_URL: "http://stalwart-mail:8080"
      STALWART_ADMIN_USER: "admin"
      STALWART_ADMIN_PASS: "${PASSWORD}"
      DOMAIN: "${DOMAIN}"
      NEXTCLOUD_CONTAINER_NAME: "nextcloud"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./admin/backend:/app
    depends_on:
      - authentikserver
      - stalwart
    networks:
      - caddy-proxy

  ## Static hosting
  homepage:
    container_name: homepage
    image: nginx:latest
    restart: unless-stopped
    networks:
      - caddy-proxy
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./static/html:/usr/share/nginx/html:ro
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://localhost/ || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  database:
    driver: local

networks:
  caddy-proxy:
    external: true
  database:
    external: true
